// Generated by CoffeeScript 1.6.3
(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};window.TimeSeriesAnalyzer=function(){function t(t){this.barebone=e(this.barebone,this);this.genetic=e(this.genetic,this);this.graph=e(this.graph,this);this.aggregate=e(this.aggregate,this);this.loess_coords=e(this.loess_coords,this);this.coords=e(this.coords,this);this.point=e(this.point,this);this.snap=e(this.snap,this);this.names=e(this.names,this);this.data=t;this.data.forEach(function(e){e.timestamp=+e.timestamp;return e.response=+e.response});this.data=this.data.sort(function(e,t){return d3.ascending(e.timestamp,t.timestamp)})}t.prototype.data=0;t.prototype.width=300;t.prototype.height=100;t.prototype.padding=10;t.prototype.format=d3.time.format("%Y-%m-%d %H:%M:%S");t.prototype.x=d3.time.scale();t.prototype.y=d3.scale.linear();t.prototype.line=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate("monotone");t.prototype.x_functor=d3.functor(function(e){return e.timestamp});t.prototype.y_functor=d3.functor(function(e){return e.response});t.prototype.z_functor=d3.functor(function(e){return e.name});t.prototype.millis_to_date=d3.functor(function(e){return new Date(this.x_functor(e))});t.prototype.names=function(){return d3.set(this.data.map(this.z_functor)).values()};t.prototype.snap=function(e){var t=this;return this.data.filter(function(n){return t.z_functor(n)===e})};t.prototype.stats=function(e,t){var n,r;n=e||this.y_functor;t!=null?r=this.snap(t):r=this.data;return{mean:+d3.mean(r,n),min:+d3.min(r,n),max:+d3.max(r,n),count:+r.length,sd:+Math.sqrt(science.stats.variance(r.map(n)))}};t.prototype.point=function(e){return{x:this.x(this.x_functor(e)),y:this.y(this.y_functor(e))}};t.prototype.coords=function(e){var t,n,r,i=this;r=this.snap(e);t=d3.extent(r.map(function(e){return i.millis_to_date(e)}));this.x.domain(t).range([this.padding,this.width-this.padding]);n=[0,d3.max(r.map(function(e){return i.y_functor(e)}))];this.y.domain(n).range([this.height,this.padding]);return r.map(function(e){return[i.x(i.x_functor(e)),i.y(i.y_functor(e))]})};t.prototype.loess_coords=function(e,t){var n,r,i,s,o,u,a,f=this;o=this.snap(e);t!=null&&(o=this.aggregate(t,e));n=d3.extent(o.map(function(e){return f.millis_to_date(e)}));this.x.domain(n).range([this.padding,this.width-this.padding]);r=[0,d3.max(o.map(function(e){return f.y_functor(e)}))];this.y.domain(r).range([this.height,this.padding]);u=o.map(function(e){return f.point(e)}).map(function(e){return e.x});a=o.map(function(e){return f.point(e)}).map(function(e){return e.y});i=science.stats.loess().bandwidth(.5);return s=d3.zip(u,i(u,a))};t.prototype.aggregate=function(e,t){var n,r,i,s,o=this;i=d3.nest().key(function(e){return o.format(o.millis_to_date(e))}).rollup(function(e){return d3.mean(e.map(o.y_functor))}).entries(this.data.filter(function(e){return e.name===t}));i.forEach(function(e){e.timestamp=o.format.parse(e.key);e.response=+e.values;return e});s=i[0].timestamp;r=0;n=d3.nest().key(function(t){return Math.floor(r++/e)}).rollup(function(e){return d3.mean(e.map(o.y_functor))}).entries(i);return n.map(function(t){var n;n=s.getTime()+parseInt(t.key)*1e3*e;return{timestamp:new Date(n),response:+t.values}})};t.prototype.graph=function(e,t,n,r){var i,s,o,u,a,f,l,c,h,p,d=this;l=this.aggregate(n,t);s=d3.extent(l.map(function(e){return d.millis_to_date(e)}));this.x.domain(s).range([this.padding,this.width-this.padding]);o=[0,d3.max(l.map(function(e){return d.y_functor(e)}))];this.y.domain(o).range([this.height,this.padding]);i=!1;if(d3.select("#"+(""+e)).select("svg").size()===0){c=d3.select("#"+(""+e)).append("svg");i=!0}else c=d3.select("#"+(""+e)).select("svg");c.attr("width",this.width).attr("height",this.height);c.selectAll("text").remove();c.append("text").attr("x",this.width).attr("y",this.padding).text(t);c.append("text").attr("x",this.padding).attr("y",this.padding).text(function(e,n){return d.names().indexOf(t)});i?c.append("path").datum(l).attr("d",function(e){return d.line(e.map(function(e){return d.point(e)}))}).attr("class","mosaic"):c.select("path").datum(l).attr("d",function(e){return d.line(e.map(function(e){return d.point(e)}))});c.selectAll("path.loess").remove();if(r){h=l.map(function(e){return d.point(e)}).map(function(e){return e.x});p=l.map(function(e){return d.point(e)}).map(function(e){return e.y});u=science.stats.loess().bandwidth(.5);a=d3.zip(h,u(h,p));f=a.map(function(e){return{x:e[0],y:e[1]}});c.append("path").datum(f).attr("d",function(e){return d.line(e)}).attr("class","loess")}return c.size()!=null};t.prototype.dna=function(e,t,n){var r,i,s,o,u,a,f,l,c=this;t==null&&(t=7);n==null&&(n=.2);u=["a","b","c","d","e","f"];l=this.snap(e);r=l.length;f=Math.ceil(r/t);s=0;o=d3.nest().key(function(e){return Math.floor(s++/f)}).rollup(function(e){return d3.mean(e.map(c.y_functor))}).entries(l);science.stats.loess().bandwidth(n);a=d3.scale.linear().domain([this.height,this.padding]).rangeRound([0,5]);i="";this.y.domain([0,d3.max(o.map(function(e){return e.values}))]).range([this.height,this.padding]);o.forEach(function(e){return i+=u[a(c.y(e.values))]});return i};t.prototype.genetic=function(){var e=this;return this.names().map(function(t){return e.dna(t)})};t.prototype.barebone=function(){return d3.set(this.genetic()).values()};return t}();window.TimeSeriesGraph=function(){function o(e){this.data=e}var e,t,n,r,i,s;r=300;n=100;t=d3.time.format("%Y-%m-%d %H:%M:%S");e=d3.scale.category10();i=d3.time.scale();s=d3.scale.linear();o.line=d3.svg.line();o.ts_stats=function(e,t){var n;return n={mean:d3.mean(e,t),sd:Math.sqrt(science.stats.variance(e.map(function(e){return e.response}))),min:d3.min(e,t),max:d3.max(e,t),count:e.length,raw:e}};o.ts_roll=function(e){return this.ts_stats(e.map(function(e){return{timestamp:e.timestamp,response:e.response}}),d3.functor(function(e){return e.response}))};o.pointify=function(e){return{x:i(e.timestamp),y:s(e.response)}};o.aggregate=function(e,n){var r,i,s,o;s=0;i=d3.nest().key(function(e){return t(e.timestamp)}).rollup(function(e){return d3.mean(e.map(function(e){return e.response}))}).entries(e);i.forEach(function(e){e.timestamp=t.parse(e.key);e.response=+e.values;return e});o=i[0].timestamp;r=d3.nest().key(function(e){return Math.floor(s++/n)}).rollup(function(e){return d3.mean(e.map(function(e){return e.response}))}).entries(i);r.forEach(function(e){var t;t=o.getTime()+parseInt(e.key)*1e3*n;e.timestamp=new Date(t);e.response=+e.values;return e});return r};o.graph_data=function(e,t){var u,a,f,l,c,h;a=e.sort(function(e,t){return d3.ascending(+e.timestamp,+t.timestamp)});a.forEach(function(e){e.timestamp=new Date(+e.timestamp);return e.response=+e.response});u=d3.nest().key(function(e){return e.name}).rollup(function(e){return o.ts_roll(e)}).entries(a);h=d3.set(a.map(function(e){return e.name})).values();i.domain(d3.extent(a.map(function(e){return e.timestamp}))).range([10,r-10]);this.line.x(function(e){return e.x}).y(function(e){return e.y}).interpolate("monotone");c=d3.functor(this.pointify);l=a.map(c);f=science.stats.loess().bandwidth(.5);u.forEach(function(e,i){var u;u=d3.select("#graph").append("svg");u.attr("width",r).attr("height",n);u.append("text").attr("x",r).attr("y",10).text(function(t){return e.key});u.append("path").datum(e).attr("d",function(e){var r,i;r=o.aggregate(e.values.raw,t);s.domain([0,d3.max(r.map(function(e){return e.response}))]).range([n,10]);i=r.map(o.pointify);return o.line(i)}).attr("class","mosaic");return u.append("path").datum(e).attr("d",function(e){var r,i,u,a,l,c,h;r=o.aggregate(e.values.raw,t);s.domain([0,d3.max(r.map(function(e){return e.response}))]).range([n,10]);l=r.map(o.pointify);c=l.map(function(e){return e.x});h=l.map(function(e){return e.y});i=d3.zip(c,f(c,h));u=i.map(function(e){return{x:e[0],y:e[1]}});a=o.pattern_string(u,6,d3.functor(function(e){return e.y}));return o.line(u)}).attr("class","loess")});return u};o.loessify_data=function(e){};o.pattern_string=function(e,t,r){var i,o,u,a,f,l,c;f=["a","b","c","d","e","f"];i=e.length;c=Math.ceil(i/t);u=0;a=d3.nest().key(function(e){return Math.floor(u++/c)}).rollup(function(e){return d3.median(e.map(r))}).entries(e);science.stats.loess().bandwidth(.2);l=d3.scale.linear().domain([n,10]).rangeRound([0,5]);o="";s.domain([0,d3.max(a.map(function(e){return e.values}))]).range([n,10]);a.forEach(function(e){return o+=f[l(s(e.values))]});return o};return o}()}).call(this);