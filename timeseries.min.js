// Generated by CoffeeScript 1.6.3
(function(){window.TimeSeriesGraph=function(){function o(e){this.data=e}var e,t,n,r,i,s;r=300;n=100;t=d3.time.format("%Y-%m-%d %H:%M:%S");e=d3.scale.category10();i=d3.time.scale();s=d3.scale.linear();o.line=d3.svg.line();o.ts_stats=function(e,t){var n;return n={mean:d3.mean(e,t),sd:Math.sqrt(science.stats.variance(e.map(function(e){return e.response}))),min:d3.min(e,t),max:d3.max(e,t),count:e.length,raw:e}};o.ts_roll=function(e){return this.ts_stats(e.map(function(e){return{timestamp:e.timestamp,response:e.response}}),d3.functor(function(e){return e.response}))};o.pointify=function(e){return{x:i(e.timestamp),y:s(e.response)}};o.aggregate=function(e,n){var r,i,s,o;s=0;i=d3.nest().key(function(e){return t(e.timestamp)}).rollup(function(e){return d3.mean(e.map(function(e){return e.response}))}).entries(e);i.forEach(function(e){e.timestamp=t.parse(e.key);e.response=+e.values;return e});o=i[0].timestamp;r=d3.nest().key(function(e){return Math.floor(s++/n)}).rollup(function(e){return d3.mean(e.map(function(e){return e.response}))}).entries(i);r.forEach(function(e){var t;t=o.getTime()+parseInt(e.key)*1e3*n;e.timestamp=new Date(t);e.response=+e.values;return e});return r};o.graph_data=function(e,t){var u,a,f,l,c,h;a=e.sort(function(e,t){return d3.ascending(+e.timestamp,+t.timestamp)});a.forEach(function(e){e.timestamp=new Date(+e.timestamp);return e.response=+e.response});u=d3.nest().key(function(e){return e.name}).rollup(function(e){return o.ts_roll(e)}).entries(a);h=d3.set(a.map(function(e){return e.name})).values();i.domain(d3.extent(a.map(function(e){return e.timestamp}))).range([10,r-10]);this.line.x(function(e){return e.x}).y(function(e){return e.y}).interpolate("monotone");c=d3.functor(this.pointify);l=a.map(c);f=science.stats.loess().bandwidth(.5);u.forEach(function(e,i){var u;u=d3.select("#graph").append("svg");u.attr("width",r).attr("height",n);u.append("text").attr("x",r).attr("y",10).text(function(t){return e.key});u.append("path").datum(e).attr("d",function(e){var r,i;r=o.aggregate(e.values.raw,t);s.domain([0,d3.max(r.map(function(e){return e.response}))]).range([n,10]);i=r.map(o.pointify);return o.line(i)}).attr("class","mosaic");return u.append("path").datum(e).attr("d",function(e){var r,i,u,a,l,c,h;r=o.aggregate(e.values.raw,t);s.domain([0,d3.max(r.map(function(e){return e.response}))]).range([n,10]);l=r.map(o.pointify);c=l.map(function(e){return e.x});h=l.map(function(e){return e.y});i=d3.zip(c,f(c,h));u=i.map(function(e){return{x:e[0],y:e[1]}});a=o.pattern_string(u,6,d3.functor(function(e){return e.y}));return o.line(u)}).attr("class","loess")});return u};o.loessify_data=function(e){};o.pattern_string=function(e,t,r){var i,o,u,a,f,l,c;f=["a","b","c","d","e","f"];i=e.length;c=Math.ceil(i/t);u=0;a=d3.nest().key(function(e){return Math.floor(u++/c)}).rollup(function(e){return d3.median(e.map(r))}).entries(e);science.stats.loess().bandwidth(.2);l=d3.scale.linear().domain([n,10]).rangeRound([0,5]);o="";s.domain([0,d3.max(a.map(function(e){return e.values}))]).range([n,10]);a.forEach(function(e){return o+=f[l(s(e.values))]});return o};return o}()}).call(this);